CREATE DATABASE pos_system;
USE pos_system;

CREATE TABLE Orders
(
    orderID INT NOT NULL,
    orderDate DATE,
    totalPrice INT,
    PRIMARY KEY (orderID)
);

CREATE TABLE Item
(
    itemID INT NOT NULL, 
    name VARCHAR(128),
    price DOUBLE, 
    stock INT, 
    itemType VARCHAR(32),
    PRIMARY KEY (itemID)
);

CREATE TABLE OrderItem
(
    orderID INT NOT NULL, 
    itemID INT NOT NULL, 
    quantity INT, 
    subtotal DOUBLE, 
    FOREIGN KEY (orderID) REFERENCES Orders(orderID),
    FOREIGN KEY (itemID) REFERENCES Item(itemID)
);

SELECT * FROM Orders;
SELECT * FROM Item;
SELECT * FROM OrderItem;


DELIMITER //

CREATE TRIGGER orderitem_insert_trigger
BEFORE INSERT ON OrderItem
FOR EACH ROW
BEGIN
    DECLARE is_pizza INT;
    DECLARE is_friday INT;

    -- Check if the inserted item is a pizza
    SELECT COUNT(*) INTO is_pizza
    FROM Item
    WHERE itemID = NEW.itemID AND itemType = 'pizza';

    -- Check if the current day is Friday (day of the week: 5)
    SELECT IF(DAYOFWEEK(CURRENT_DATE()) = 5, 1, 0) INTO is_friday;

    -- Decrease the price temporarily by 20% if it's a pizza on Friday
    IF is_pizza = 1 AND is_friday = 1 THEN
        SET NEW.subtotal = NEW.subtotal * 0.8;
    ELSE
        SET NEW.subtotal = 99;
    END IF;
END //

DELIMITER ;